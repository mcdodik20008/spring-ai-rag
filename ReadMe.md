# Spring¬†AI¬†RAG

> **R**etrieval‚Äë**A**ugmented **G**eneration –Ω–∞ –±–∞–∑–µ Spring Boot 3.4 –∏ Kotlin 1.9. –ü—Ä–æ–µ–∫—Ç –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω—É—é LLM (
> —á–µ—Ä–µ–∑ **Ollama**) –∏ –≤–µ–∫—Ç–æ—Ä–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ **pgvector** –≤ –≥–æ—Ç–æ–≤—ã–π REST‚Äë—Å–µ—Ä–≤–∏—Å –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –≤–∞—à–∏–º –¥–æ–∫—É–º–µ–Ω—Ç–∞–º –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
> –æ—Ç–≤–µ—Ç–æ–≤.

---

## üöÄ¬†–ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

| ¬†–ú–æ–¥—É–ª—å¬†            | ¬†–ß—Ç–æ –¥–µ–ª–∞–µ—Ç¬†                                                                                                        | ¬†–ì–¥–µ —Å–º–æ—Ç—Ä–µ—Ç—å¬†                                    |
|---------------------|---------------------------------------------------------------------------------------------------------------------|---------------------------------------------------|
| Ingest¬†pipeline     | –†–∞–∑–±–∏—Ä–∞–µ—Ç PDF¬†/ Markdown¬†/¬†–¥—Ä—É–≥–æ–µ —á–µ—Ä–µ–∑ Apache¬†Tika, —á–∏—Å—Ç–∏—Ç —Ç–µ–∫—Å—Ç, —Ä–µ–∂–µ—Ç –Ω–∞ —á–∞–Ω–∫–∏, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ –≤–µ–∫—Ç–æ—Ä–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ | `utils.document.*`, `IngestController`            |
| Vector¬†Store        | Custom¬†adapter –ø–æ–≤–µ—Ä—Ö **PostgreSQL¬†+¬†pgvector** <br/>‚Äî —Å–≤–æ–π `PgVectorStoreImpl`, –º–∞–ø–ø–µ—Ä—ã MyBatis, K‚ÄëNN¬†–ø–æ –∫–æ—Å–∏–Ω—É—Å—É  | `db.*`                                            |
| Embedding           | –õ–æ–∫–∞–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å `nomic‚Äëembed‚Äëtext` –∏–∑ **Ollama**                                                                   | `application.yaml`¬†‚Üí `spring.ai.ollama.embedding` |
| LLM¬†(—á–∞—Ç)           | –ü–æ‚Äë—É–º–æ–ª—á–∞–Ω–∏—é `owl/t‚Äëlite` (Ollama) + –ø—Ä–∏–º–µ—Ä –¥–ª—è **OpenRouter**                                                      | `application.yaml`, `AskController`               |
| RAG‚Äë—Å–µ—Ä–≤–∏—Å          | 1. –∏—â–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —á–∞–Ω–∫–∏ ‚Üí 2. —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –ø—Ä–æ–º–ø—Ç ‚Üí 3. –≤—ã–∑—ã–≤–∞–µ—Ç LLM ‚Üí 4. –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–≤–µ—Ç                             | `RagService`                                      |
| REST¬†API            | `/api/ingest` –∏ `/api/ask`                                                                                          | `controller.*`                                    |
| –î–æ–∫–µ—Ä–∏–∑–∞—Ü–∏—è         | `docker-compose.yaml` –ø–æ–¥–Ω–∏–º–∞–µ—Ç pgvector¬†–∏¬†Ollama —Å –∫–µ—à–µ–º –º–æ–¥–µ–ª–µ–π                                                   | –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞                                    |
| Kotlin¬†/ Gradle¬†KTS | –í—Å–µ –∫–æ–Ω—Ñ–∏–≥–∏ –¥–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω–æ, Java¬†17 toolchain                                                                         | `build.gradle.kts`                                |

> **Zero‚ÄëCloud**: –¥–ª—è —Ä–∞–±–æ—Ç—ã –Ω–µ –Ω—É–∂–µ–Ω –≤–Ω–µ—à–Ω–∏–π –∏–Ω—Ç–µ—Ä–Ω–µ—Ç ‚Äî –º–æ–¥–µ–ª–∏ –∏ –ë–î –∫—Ä—É—Ç—è—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ.

---

## ‚ö°Ô∏è¬†–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

```bash
# 1. –ö–ª–æ–Ω–∏—Ä—É–µ–º –ø—Ä–æ–µ–∫—Ç
$ git clone https://github.com/mcdodik20008/spring-ai-rag.git
$ cd spring-ai-rag

# 2. –ü–æ–¥–Ω–∏–º–∞–µ–º –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É (PostgreSQL¬†+ pgvector, Ollama)
$ docker compose up -d
#¬†–ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ –¥–æ–∫–∞—á–∞–µ—Ç –º–æ–¥–µ–ª–∏ Ollama –∏ —Å–æ–∑–¥–∞—Å—Ç –ë–î ragdb

# 3. (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) –∑–∞–¥–∞—ë–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
$ export OPENROUTER_API_KEY=<your-key>
# –∏–ª–∏ –ø—Ä–∞–≤–∏–º src/main/resources/application.yaml

# 4. –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å
$ ./gradlew bootRun
# –ª–∏–±–æ –ø–∞–∫–µ—Ç–∏—Ä—É–µ–º jar –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –∫–∞–∫ systemd/Docker
```

–ü–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–ª—É—à–∞–µ—Ç **`http://localhost:8080`**.

---

## üõ∞¬†API Reference

### 1.¬†POST¬†`/api/ingest/pdf`

–ó–∞–≥—Ä—É–∑–∏—Ç—å PDF –æ–¥–Ω–∏–º multipart‚Äë–∑–∞–ø—Ä–æ—Å–æ–º.

| ¬†–ü–∞—Ä–∞–º–µ—Ç—Ä¬†          | –¢–∏–ø    | –û–ø–∏—Å–∞–Ω–∏–µ                                          |
|---------------------|--------|---------------------------------------------------|
| `file`              | `file` | PDF‚Äë—Ñ–∞–π–ª                                          |
| `skipPages`         | int    | –°–∫–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å                 |
| `throwPagesFromEnd` | int    | –°–∫–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å—Ç—Ä–∞–Ω–∏—Ü –æ—Ç–±—Ä–æ—Å–∏—Ç—å               |
| `headerFooterLines` | int    | –°–∫–æ–ª—å–∫–æ –≤–µ—Ä—Ö–Ω–∏—Ö/–Ω–∏–∂–Ω–∏—Ö —Å—Ç—Ä–æ–∫ —Å—á–∏—Ç–∞—Ç—å –∫–æ–ª–æ–Ω—Ç–∏—Ç—É–ª–æ–º |
| `repeatThreshold`   | double | –ü–æ—Ä–æ–≥ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ —Å—Ç—Ä–æ–∫                |

**–ü—Ä–∏–º–µ—Ä (cURL)**

```bash
curl -F "file=@spec.pdf" \
     -F skipPages=0 \
     -F throwPagesFromEnd=0 \
     -F headerFooterLines=2 \
     -F repeatThreshold=0.9 \
     http://localhost:8080/api/ingest/pdf
```

### 2.¬†POST¬†`/api/ask`

```json
{
  "question": "–ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å pgvector¬†–≤¬†PostgreSQL?"
}
```

–û—Ç–≤–µ—Ç:

```json
{
  "answer": "‚Ä¶"
}
```

### 3.¬†GET¬†`/api/ask?quest=‚Ä¶`

–£–ø—Ä–æ—â—ë–Ω–Ω—ã–π –≤—ã–∑–æ–≤ LLM –±–µ–∑ RAG —á–µ—Ä–µ–∑ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π —á–∞—Ç‚Äë–∫–ª–∏–µ–Ω—Ç (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏).

---

## üõ†¬†–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

```mermaid
flowchart TD
    A[–î–æ–∫—É–º–µ–Ω—Ç (PDF / MD / DOCX / video)] --> B[DocumentWorker]
    B -->|Text & metadata| C[Chunker]
    C -->|–ß–∞–Ω–∫ + embedding| D[PgVector (pgvector)]
    E[–í–æ–ø—Ä–æ—Å] --> F[Ollama¬†Embedding]
    F -->|query‚Äëvector| D
    D -->|K –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ—Ö–æ–∂–∏—Ö| G[PromptFormatter]
    G --> H[Ollama ChatLLM]
    H --> I[–û—Ç–≤–µ—Ç]
```

* –ö–∞—Å—Ç–æ–º–Ω—ã–π `PgVectorStoreImpl` —Ö—Ä–∞–Ω–∏—Ç embedding‚Äë–≤–µ–∫—Ç–æ—Ä –∫–∞–∫ `vector(768)` + –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ.
* –ù–∞ –ø–æ–∏—Å–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–ø–µ—Ä–∞—Ç–æ—Ä `<=>`pgvector (cosine distance).
* –ü—Ä–æ–º–ø—Ç —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –≤ `ContextMarkdownFormatter` –∏ `PromptTemplate` ‚Äî —Ç–∞–∫ –≤—ã –ª–µ–≥–∫–æ –º–µ–Ω—è–µ—Ç–µ —Å–∏—Å—Ç–µ–º–Ω—ã–π —Ç–µ–∫—Å—Ç.

---

## üîå¬†–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ª–µ–∂–∞—Ç –≤ `src/main/resources/application.yaml`. –ì–ª–∞–≤–Ω—ã–µ –∏–∑ –Ω–∏—Ö:

```yaml
a spring:
  ai:
    ollama:
      base-url: http://localhost:11434
      embedding:
        model: nomic-embed-text
      chat:
        options:
          model: owl/t-lite
    vectorstore:
      pgvector:
        initialize-schema: false  # –µ—Å–ª–∏ TRUE ‚Äî —Å–æ–∑–¥–∞—Å—Ç —Ç–∞–±–ª–∏—Ü—ã —Å–∞–º–∞
  datasource:
    url: jdbc:postgresql://localhost:5432/ragdb
    username: postgres
    password: postgres
```

> **–°–æ–≤–µ—Ç:** —Ö—Ä–∞–Ω–∏—Ç–µ —Å–µ–∫—Ä–µ—Ç—ã (API‚Äë–∫–ª—é—á–∏) –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–ª–∏ vault, –∞ –Ω–µ –≤ YAML.

---

## üß©¬†–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞

| ¬†–•–æ—Ç–∏—Ç–µ¬†                        | ¬†–î–µ–π—Å—Ç–≤–∏—è¬†                                                                         |
|---------------------------------|------------------------------------------------------------------------------------|
| –î—Ä—É–≥–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫ (HTML, Git, S3) | –ù–∞–ø–∏—à–∏—Ç–µ —Å–≤–æ–π `DocumentWorker` –∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ –∫–∞–∫ Spring‚Äëbean                   |
| –û–±–ª–∞—á–Ω—ã–π LLM                    | –ü–æ–¥–∫–ª—é—á–∏—Ç–µ Spring‚ÄëAI starter –Ω—É–∂–Ω–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –∏ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ `chat.options.model` |
| –ò–Ω–∞—è –°–£–ë–î                       | –ò–º–ø–ª–µ–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ `CustomVectorStore` —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `VectorStore`                  |
| –§—Ä–æ–Ω—Ç–µ–Ω–¥ —á–∞—Ç‚Äë–±–æ—Ç                | –õ—é–±–æ–π SPA ‚Üë REST¬†API –∏–ª–∏ —á–µ—Ä–µ–∑ WebSocket UIs –æ–∑–Ω–∞–∫–æ–º—å—Ç–µ—Å—å —Å Spring¬†AI Streaming    |

---

## üó∫¬†Roadmap / TODO

* [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è TL;DR summary –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞
* [ ] –í—ã–Ω–µ—Å—Ç–∏ –ø—Ä–æ–º–ø—Ç –≤ –ë–î
* [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –ø—Ä–µ–¥–º–µ—Ç–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏
* [ ] –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π —á–∞–Ω–∫–∏–Ω–≥
* [ ] Query Rewriting —Å LLM
* [ ] –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫ (BM25 + Embeddings)
* [ ] Reranking (–ø–µ—Ä–µ—Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ)
* [ ] LLM-based Relevance Scoring
* [ ] –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –ø–æ—Ä–æ–≥
* [ ] –£–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ / –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è

PR –∏ –∏–¥–µ–∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é—Ç—Å—è!‚≠êÔ∏è

---

## üìú¬†–õ–∏—Ü–µ–Ω–∑–∏—è

MIT ‚Äî –¥–µ–ª–∞–π—Ç–µ, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ, –Ω–æ –Ω–µ –∑–∞–±—É–¥—å—Ç–µ –ø—Ä–æ –∑–≤—ë–∑–¥–æ—á–∫—É üòä
