<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mcdodik.springai.db.mybatis.mapper.DocumentInfoMapper">

    <!-- resultMap для DocumentInfo -->
    <resultMap id="DocumentInfo" type="mcdodik.springai.db.model.rag.DocumentInfo">
        <constructor>
            <arg name="id" column="id" javaType="java.util.UUID"
                 typeHandler="mcdodik.springai.db.mybatis.handler.UUIDTypeHandler"/>
            <arg name="fileName" column="file_name" javaType="java.lang.String"/>
            <arg name="extension" column="extension" javaType="java.lang.String"/>
            <arg name="hash" column="file_hash" javaType="java.lang.String"/>
            <arg name="chunkCount" column="chunk_count" javaType="java.lang.Integer"/>
            <arg name="createdAt" column="created_at" javaType="java.time.LocalDateTime"/>
            <arg name="summary" column="summary" javaType="java.lang.String"/>
        </constructor>
    </resultMap>

    <select id="findAll" resultMap="DocumentInfo">
        SELECT id,
        file_name,
        extension,
        file_hash,
        chunk_count,
        created_at,
        summary
        FROM document_info
    </select>

    <!-- Получение одного документа по id -->
    <select id="findById" parameterType="java.util.UUID" resultMap="DocumentInfo">
        SELECT id,
        file_name,
        extension,
        file_hash,
        chunk_count,
        created_at,
        summary
        FROM document_info
        WHERE id = #{id, javaType=java.util.UUID, typeHandler=mcdodik.springai.db.mybatis.handler.UUIDTypeHandler}
    </select>

    <select id="searchByFilenames" resultMap="DocumentInfo">
        SELECT * FROM public.document_info
        WHERE file_name IN
        <foreach collection="fileNames" item="fn" open="(" separator="," close=")">
            #{fn}
        </foreach>
    </select>


    <!-- Поиск по file_name с ILIKE -->
    <select id="searchByFilenameLike" resultMap="DocumentInfo" parameterType="java.lang.String">
        SELECT *
        FROM document_info
        WHERE file_name ILIKE '%' || #{keyword} || '%'
    </select>

    <!-- Удаление по id -->
    <delete id="delete" parameterType="java.util.UUID">
        DELETE FROM document_info
        WHERE id = #{id, javaType=java.util.UUID, typeHandler=mcdodik.springai.db.mybatis.handler.UUIDTypeHandler}
    </delete>

    <!-- Поиск документа по имени и хэшу -->
    <select id="searchByNameAndHash" resultMap="DocumentInfo" parameterType="map">
        <![CDATA[
        SELECT id, file_name, extension, file_hash, chunk_count, created_at, summary
        FROM document_info
        WHERE file_hash = #{hash} AND file_name = #{fileName}
        ]]>
    </select>

    <!-- Только id по имени и хэшу — для rag_chunks.document_id -->
    <select id="getIdByFileNameAndHash" resultType="java.util.UUID" parameterType="map">
        <![CDATA[
        SELECT id
        FROM document_info
        WHERE file_hash = #{hash} AND file_name = #{fileName}
        ]]>
    </select>

    <!-- Вставка документа -->
    <insert id="insert" parameterType="mcdodik.springai.db.model.rag.DocumentInfo">
        INSERT INTO document_info (
        id,
        file_name,
        extension,
        file_hash,
        chunk_count,
        created_at,
        summary
        ) VALUES (
        #{id, javaType=java.util.UUID, typeHandler=mcdodik.springai.db.mybatis.handler.UUIDTypeHandler},
        #{fileName},
        #{extension},
        #{hash},
        #{chunkCount},
        #{createdAt},
        #{summary}
        )
    </insert>

</mapper>
