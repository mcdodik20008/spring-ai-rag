<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mcdodik.springai.rag.db.mybatis.mapper.RagChunkMapper">

    <resultMap id="RagChunkResultMap" type="mcdodik.springai.rag.db.RagChunkEntity">
        <id property="id" column="doc_id" javaType="java.util.UUID"
            typeHandler="mcdodik.springai.rag.db.mybatis.handler.UUIDTypeHandler"/>
        <result property="content" column="content"/>
        <result property="embedding" column="embedding"
                typeHandler="mcdodik.springai.rag.db.mybatis.handler.FloatListTypeHandler"/>
        <result property="type" column="type"/>
        <result property="source" column="source"/>
        <result property="chunkIndex" column="chunk_index" javaType="java.lang.Integer"/>
        <result property="fileName" column="file_name"/>
        <result property="extension" column="extension"/>
        <result property="hash" column="file_hash"/>
        <result property="createdAt" column="created_at"/>
    </resultMap>


    <!-- Поиск по embedding -->
    <select id="searchByEmbedding" resultMap="RagChunkResultMap">
        <![CDATA[
        SELECT id,
               content,
               embedding,
               type,
               source,
               chunk_index,
               file_name,
               extension,
               file_hash,
               created_at
        FROM public.rag_chunks
        ORDER BY embedding <#> CAST(
                #{embedding, jdbcType=OTHER, typeHandler=mcdodik.springai.rag.db.mybatis.handler.FloatListTypeHandler}
            AS vector
        )
        ]]>
    </select>

    <!-- Вставка rag-чанк -->
    <insert id="insert" parameterType="mcdodik.springai.rag.db.mybatis.handler.UUIDTypeHandler">
        INSERT INTO rag_chunks (
        id,
        content,
        embedding,
        type,
        source,
        chunk_index,
        file_name,
        extension,
        file_hash,
        created_at
        ) VALUES (
        #{id, typeHandler=mcdodik.springai.rag.db.mybatis.handler.UUIDTypeHandler},
        #{content},
        #{embedding, typeHandler=mcdodik.springai.rag.db.mybatis.handler.FloatListTypeHandler},
        #{type},
        #{source},
        #{chunkIndex},
        #{fileName},
        #{extension},
        #{hash},
        #{createdAt}
        )
    </insert>

</mapper>
